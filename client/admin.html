<html>
  <head>
    <title>Sistema de Tickets de Soporte - Admin</title>
    <style>
      :root {
        --primary: #2c3e50;
        --secondary: #3498db;
        --success: #27ae60;
        --warning: #f39c12;
        --danger: #e74c3c;
        --light: #ecf0f1;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: var(--light);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: var(--primary);
        color: white;
        padding: 1rem;
        text-align: center;
        border-radius: 8px;
        margin-bottom: 2rem;
      }

      .nav-menu {
        background: var(--secondary);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
      }

      .nav-menu a {
        color: white;
        text-decoration: none;
        margin: 0 15px;
        font-weight: bold;
        transition: color 0.3s;
      }

      .nav-menu a:hover {
        color: var(--light);
      }

      .stats-panel {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .stat-card h3 {
        color: var(--primary);
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }

      .stat-card p {
        color: var(--secondary);
      }

      .admin-controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .filter-group {
        flex: 1;
      }

      .ticket-card {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .ticket-card:hover {
        transform: translateY(-2px);
      }

      .priority-high {
        border-left: 4px solid var(--danger);
      }

      .priority-medium {
        border-left: 4px solid var(--warning);
      }

      .priority-low {
        border-left: 4px solid var(--success);
      }

      .estado-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: bold;
      }

      .status-abierto {
        background: var(--warning);
        color: white;
        padding: 4px;
       
      }

      .status-cerrado {
        background: var(--success);
        color: white;
        padding: 4px;
      }

      .btn {
        background: var(--secondary);
        color: white;
        padding: 1rem 2rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .btn:hover {
        background: var(--primary);
        transform: translateY(-2px);
      }

      .admin-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .btn-delete {
        background: var(--danger);
      }

      .btn-assign {
        background: var(--success);
      }

      .btn-small {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
      }

      .hidden {
        display: none;
      }
      dialog {
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        padding: 20px;
        max-width: 400px;
        width: 100%;
        background-color: #fff;
        font-family: Arial, sans-serif;
      }

      dialog::backdrop {
        background: rgba(0, 0, 0, 0.5);
      }

      #assignTicketForm {
        display: flex;
        flex-direction: column;
      }

      #assignTicketForm label {
        margin-bottom: 8px;
        font-weight: bold;
      }

      #assignTicketForm select {
        margin-bottom: 16px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      #assignTicketForm button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        background-color: #007bff;
        color: #fff;
        font-size: 16px;
        cursor: pointer;
      }

      #assignTicketForm button:hover {
        background-color: #0056b3;
      }
    </style>
    <script src="js/login.js" defer></script>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1>Panel de Administración - Tickets de Soporte</h1>
      </header>

      <nav class="nav-menu">
        <a href="/admin">Inicio</a>
        <a href="/tickets" onclick="showView('ticketsView')">Tickets</a>
        <a href="/users">Usuarios</a>
      </nav>

      <section id="ticketsView" class="view">
        <section class="stats-panel">
          <div class="stat-card">
            <h3 id="totalTickets">0</h3>
            <p>Total Tickets</p>
          </div>
          <div class="stat-card">
            <h3 id="openTickets">0</h3>
            <p>Tickets Abiertos</p>
          </div>
          <div class="stat-card">
            <h3 id="highPriority">0</h3>
            <p>Alta Prioridad</p>
          </div>
          <div class="stat-card">
            <h3 id="resolvedToday">0</h3>
            <p>Resueltos Hoy</p>
          </div>
        </section>

        <section class="admin-controls">
          <div class="filter-group">
            <label for="filterStatus">Estado</label>
            <select id="filterStatus" class="form-control">
              <option value="all">Todos</option>
              <option value="abierto">Abiertos</option>
              <option value="cerrado">Cerrados</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterPriority">Prioridad</label>
            <select id="filterPriority" class="form-control">
              <option value="all">Todas</option>
              <option value="high">Alta</option>
              <option value="medium">Media</option>
              <option value="low">Baja</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterDepartment">Departamento</label>
            <select id="filterDepartment" class="form-control">
              <option value="all">Todos</option>
              <option value="it">IT</option>
              <option value="maintenance">Mantenimiento</option>
              <option value="hr">Recursos Humanos</option>
              <option value="finance">Finanzas</option>
            </select>
          </div>
        </section>

        <section class="tickets-list">
          <h2>Gestión de Tickets</h2>
          <div id="ticketsList"></div>
        </section>
      </section>

      <section id="reportsView" class="view hidden">
        <h2>Reportes de Tickets</h2>
        <p>
          Esta vista mostrará reportes analíticos sobre los tickets gestionados.
        </p>
        <div id="reportsContent">Contenido de los reportes aquí...</div>
      </section>

      <section id="settingsView" class="view hidden">
        <h2>Configuración del Sistema</h2>
        <p>Aquí puedes modificar los parámetros del sistema de tickets.</p>
        <div id="settingsContent">Opciones de configuración aquí...</div>
      </section>
    </div>

    <script>
      class AdminTicketSystem {
        constructor() {
          this.tickets = this.loadSampleData();
          this.ticketsList = document.getElementById("ticketsList");
          this.filterStatus = document.getElementById("filterStatus");
          this.filterPriority = document.getElementById("filterPriority");
          this.filterDepartment = document.getElementById("filterDepartment");

          this.deleteTicket = this.deleteTicket;
          this.assignTicket = this.assignTicket.bind(this);
          this.toggleTicketStatus = this.toggleTicketStatus.bind(this);
          this.init();
        }

        async loadSampleData() {
          await fetch("api/mytickets", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              authorization: `Bearer ${sessionStorage.getItem("token")}`,
            },
          })
            .then((res) => res.json())
            .then((data) => {
              this.tickets = data;
              console.log(this.tickets);
              this.renderTickets();
              this.updateStats();
            });
        }

        init() {
          this.filterStatus.addEventListener("change", () =>
            this.renderTickets()
          );
          this.filterPriority.addEventListener("change", () =>
            this.renderTickets()
          );
          this.filterDepartment.addEventListener("change", () =>
            this.renderTickets()
          );

          this.ticketsList.addEventListener("click", (e) => {
            const card = e.target.closest(".ticket-card");
            if (!card) return;

            const ticketId = e.target.getAttribute("data-ticket-id");

            if (e.target.classList.contains("btn-assign")) {
              this.assignTicket(ticketId);
            } else if (e.target.classList.contains("btn-delete")) {
              this.deleteTicket(ticketId);
            } else if (e.target.classList.contains("toggle-status")) {
              this.toggleTicketStatus(ticketId);
            }
          });

          this.renderTickets();
          this.updateStats();
        }

        updateStats(id) {
          if (typeof this.tickets.then === "function") return [];

          document.getElementById("totalTickets").textContent =
            this.tickets.length;
          document.getElementById("openTickets").textContent =
            this.tickets.filter((t) => t.estado === "abierto").length;
          document.getElementById("highPriority").textContent =
            this.tickets.filter((t) => t.prioridad === "alta").length;

          const today = new Date().toLocaleDateString();

          const resolvedToday = this.tickets.filter(
            (t) =>
              t.estado === "cerrado" &&
              new Date().toLocaleDateString() === today
          ).length;
          document.getElementById("resolvedToday").textContent = resolvedToday;
        }

        deleteTicket(id) {
          fetch(`api/delticket`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
              authorization: `Bearer ${sessionStorage.getItem("token")}`,
            },
            body: JSON.stringify({ uid: id }),
          });
          this.tickets = this.tickets.filter((t) => t.uid !== id);
          this.renderTickets();
          this.updateStats();
        }

        assignTicket(id) {
          const dialog = document.createElement("dialog");
          fetch("/workers/users", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              authorization: `Bearer ${sessionStorage.getItem("token")}`,
            },
          })
            .then((res) => res.json())
            .then((data) => {
              dialog.innerHTML = `
        <form id="assignTicketForm">
          <label for="assignee">Asignar a:</label>
          <select id="assignee" name="assignee" required>
            ${data
              .map(
                (user) =>
                  `<option value="${user.nombre}">${user.nombre}</option>`
              )
              .join("")}
          </select>
          <button type="submit">Asignar</button>
        </form>
      `;
              document.body.appendChild(dialog);

              const form = dialog.querySelector("#assignTicketForm");
              form.addEventListener("submit", (event) => {
                event.preventDefault();
                const assignee = form.assignee.value;
                this.updateTicketAssignee(id, assignee).then((update) => {
                  if (update) {
                    this.loadSampleData();
                    dialog.close();
                    dialog.remove();
                  }
                });
              });

              dialog.showModal();
            });
        }

        updateTicketAssignee(id, assignee) {
          return fetch(`/workers/assing`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              authorization: `Bearer ${sessionStorage.getItem("token")}`,
            },
            body: JSON.stringify({ id, assignee }),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data) {
                // Actualiza la interfaz de usuario según sea necesario
                alert("Ticket asignado correctamente");
                return true;
              } else {
                alert("Error al asignar el ticket");
                return false;
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              return false;
            });
        }

        toggleTicketStatus(id) {
          const ticket = this.tickets.find((t) => t.uid === id);
          return fetch(`/api/status`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              authorization: `Bearer ${sessionStorage.getItem("token")}`,
            },
            body: JSON.stringify({ id: id, estado: ticket.estado }),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data) {
                this.loadSampleData();
              } else {
                return false;
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              return false;
            });
        }

        filterTickets() {
          if (typeof this.tickets.then === "function") return [];
          let filtered = [...this.tickets];

          const status = this.filterStatus.value;
          const priority = this.filterPriority.value;
          const department = this.filterDepartment.value;

          if (status !== "all") {
            filtered = filtered.filter((t) => t.estado === status);
          }
          if (priority !== "all") {
            filtered = filtered.filter((t) => t.prioridad === priority);
          }
          if (department !== "all") {
            filtered = filtered.filter((t) => t.departamento === department);
          }

          return filtered;
        }

        renderTickets() {
          const filteredTickets = this.filterTickets();

          this.ticketsList.innerHTML = filteredTickets
            .map(
              (ticket) => `
            <div class="ticket-card priority-${ticket.prioridad}">
              <h3>${ticket.titulo}</h3>
              <p>${ticket.des}</p>
              <div style="margin-top: 1rem">
                <span class="status-badge status-${
                  ticket.estado
                }">${ticket.estado.toUpperCase()}</span>
                <small style="margin-left: 1rem">Departamento: ${ticket.departamento.toUpperCase()}</small>
                <small style="margin-left: 1rem">Creado: ${
                  ticket.creado
                }</small>
                ${
                  ticket.asignado
                    ? `<small style="margin-left: 1rem">Asignado a: ${ticket.asignado}</small>`
                    : ""
                }
              </div>
              <div class="admin-actions">
                <button

                  data-ticket-id=${ticket.uid}
                  class="btn btn-small toggle-status"
                  style="background: ${
                    ticket.estado === "abierto"
                      ? "var(--success)"
                      : "var(--warning)"
                  }">
                  ${
                    ticket.estado === "abierto"
                      ? "Marcar como Resuelto"
                      : "Reabrir Ticket"
                  }
                </button>
                ${
                  ticket.estado === "cerrado"
                    ? ` <button
                  onclick="adminTicketSystem.assignTicket(${ticket.uid})"
                   data-ticket-id= "${ticket.uid}"
                  class=" hidden">
                  Asignar
                </button>
                <button
                data= "${ticket.uid}"

                  class=" hidden">
                  Eliminar1
                </button>
              </div>
            </div>`
                    : ` <button
                  onclick="adminTicketSystem.assignTicket(${ticket.uid})"
                  class="btn btn-small btn-assign "
                  data-ticket-id="${ticket.uid}">
                  Asignar
                </button>
                <button
                data-ticket-id= "${ticket.uid}"
                  class="btn btn-small btn-delete ">
                  Eliminar
                </button>
              </div>
            </div>`
                }`
            )
            .join("");
        }
      }

      const adminTicketSystem = new AdminTicketSystem();
      window.adminTicketSystem = adminTicketSystem;
      function showView(viewId) {
        const views = document.querySelectorAll(".view");
        views.forEach((view) => {
          view.classList.add("hidden");
        });
        document.getElementById(viewId).classList.remove("hidden");
      }

      showView("ticketsView");
    </script>
  </body>
</html>
